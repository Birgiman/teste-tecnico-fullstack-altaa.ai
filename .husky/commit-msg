#!/usr/bin/env sh
set -e

# FunÃ§Ã£o que executa lint em um diretÃ³rio (backend, frontend, etc)
run_lint() {
  local DIR="$1"
  local LABEL="$2"

  echo "ğŸ” Executando lint em: $LABEL..."

  cd "$(dirname "$0")/../$DIR"

  if npm run lint; then
    echo "âœ… Lint passou com sucesso em: $LABEL!"
  else
    echo "âš ï¸  Lint encontrou problemas em: $LABEL. Tentando aplicar correÃ§Ãµes automÃ¡ticas..."
    
    npm run lint -- --fix
    
    echo "ğŸ” Re-adicionando arquivos corrigidos..."
    git add -u

    if npm run lint; then
      echo "âœ… Problemas corrigidos automaticamente em: $LABEL!"
    else
      echo "âŒ Ainda existem erros de lint que precisam ser corrigidos manualmente em: $LABEL."
      echo "ğŸ”’ Commit abortado."
      exit 1
    fi
  fi

  # Retorna para a raiz do repositÃ³rio antes de prosseguir
  cd - > /dev/null
}

echo "ğŸš€ Iniciando verificaÃ§Ã£o de lint em todos os mÃ³dulos..."

# Rodar lint no backend
run_lint "backend" "Backend"

# Rodar lint no frontend (se existir)
if [ -d "$(dirname "$0")/../frontend" ]; then
  run_lint "frontend" "Frontend"
else
  echo "â„¹ï¸  DiretÃ³rio frontend nÃ£o encontrado. Pulando..."
fi

echo "ğŸ‰ Todos os linters passaram com sucesso! Prosseguindo com o commit..."
